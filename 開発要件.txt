# Shopify アプリ開発要件

## フォルダ構成
bot-protection-app-minimal_02/
├─ .env.local          # 環境変数（Shopify APIキー、Firebase設定など）
├─ .gitignore
├─ next.config.js
├─ package.json
├─ tailwind.config.js
├─ tsconfig.json
└─ src/                # アプリケーション本体
   ├─ app/             # Next.js App Router ページ & API
   │  ├─ admin/        # 管理画面UI
   │  │  ├─ add-ip/    # IP登録フォーム
   │  │  ├─ list-ip/   # IPリスト表示
   │  │  └─ logs/      # アクセスログ管理UI
   │  ├─ api/          # APIルート
   │  │  ├─ admin/     # 管理用API
   │  │  │  ├─ add-ip/ # FirestoreへIP追加
   │  │  │  └─ list-ip/# FirestoreからIP一覧取得
   │  │  └─ get-ip/    # クライアントIP取得API
   │  ├─ blocked/      # ブロック時の表示ページ
   │  ├─ auth-*        # Shopify認証関連
   │  ├─ hello/        # 動作確認ページ
   │  ├─ installed/    # インストール完了ページ
   │  ├─ layout.tsx    # 全体レイアウト
   │  └─ page.tsx      # トップページ
   │
   ├─ lib/             # ライブラリ・ユーティリティ
   │  ├─ check-ip.ts   # IP判定ロジック（blockIp/unblockIp など）
   │  └─ firebase.ts   # Firebase 初期化
   │
   ├─ components/      # 共通コンポーネント
   ├─ scripts/         # 開発用スクリプト
   ├─ tests/           # テストコード
   ├─ types/           # 型定義
   └─ middleware.ts    # Next.js Middleware（IP判定＆ブロック処理）

## 開発ルール
- App Router 構成に統一（pages/ は使わない）
- Firestore を利用する API には必ず `export const runtime = "nodejs";` を記載
- 環境変数は `.env.local` に集約し Git管理外にする
- バックアップフォルダや試作コード（proxy/, *_backup_*/）は削除済み

## Shopify App Proxy 署名検証エラー事象と解決方法

### 事象
- Shopify App Proxy 経由のリクエスト署名検証に失敗し、常に `match: false` となる状態が発生。
- Client Secret の誤設定や Shopify 側の不具合を疑ったが、実際には **canonical query の組み立て誤り** が原因。

### 原因
- 署名生成時にリクエストパラメータを `&` 区切りで結合していた。  

// ❌ 誤り
return keys.map((k) => `${k}=${obj[k]}`).join("&");

// ✅ 正しい
return keys.map((k) => `${k}=${obj[k]}`).join("\\n");

### 対応
- `buildCanonicalQuery` 関数を修正し、Shopifyサポートの指摘通り `\\n` 区切りで canonical string を生成するよう修正。  
- 修正後 `/debug-params` で `match:true` を確認。  
- デバッグ用エンドポイント（`/debug-params`, `/verify`）は確認後削除済み。

### 再発防止
- **署名検証ロジックは絶対に改変せず流用する**  
- 検証は専用の `/debug-params` を一時追加して行い、完了後は必ず削除  
- 修正箇所は必ず「どこをどう直したか」を明示して管理